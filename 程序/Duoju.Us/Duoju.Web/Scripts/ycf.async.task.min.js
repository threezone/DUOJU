window.ycf_async=window.ycf_async||{};
ycf_async.__aysncTaskList=[];
ycf_async.handlerTask=function(d){var c=new Array();
c.id=d.TaskId;
c.supplierId=d.SupplierId;
c.start=Date.parse(d.StartTime);
c.end=Date.parse(d.EndTime);
c.fromId=d.FromId;
c.receiverId=d.ReceiverId;
c.title=d.Title;
c.content=d.Content;
c.taskState=d.TaskState;
c.remindType=d.RemindType;
c.remindMins=d.RemindMins;
c.allDay=false;
if(d.Supplier){c.supplierId=d.Supplier.SupplierId;
c.supplierName=d.Supplier.SupplierName;
c.telePhone=d.Supplier.TelePhone
}if(d.TaskStateInfo){if(d.TaskStateInfo.State=="重要"){c.className="fc-event-skin-important"
}else{if(d.TaskStateInfo.State=="已阅"){c.className="fc-event-skin-flag"
}else{if(d.TaskStateInfo.State=="已取消"){c.className="fc-event-skin-cancel"
}else{c.className="fc-event-skin-notread"
}}}}else{c.className="fc-event-skin-notread"
}return c
};
ycf_async.findEventById=function(c){var d=[];
if(ycf_async.__aysncTaskList&&ycf_async.__aysncTaskList.length>0){$.each(ycf_async.__aysncTaskList,function(a){if(ycf_async.__aysncTaskList[a].id==c){d.push(ycf_async.__aysncTaskList[a])
}})
}return d
};
ycf_async.updateEventStateById=function(c,d){if(ycf_async.__aysncTaskList&&ycf_async.__aysncTaskList.length>0){$.each(ycf_async.__aysncTaskList,function(a){if(ycf_async.__aysncTaskList[a].id==c){ycf_async.__aysncTaskList[a].taskState=d
}})
}};
ycf_async.findRemindTask=function(){var d=Date.today().setTimeToNow();
var e=[];
var f=0;
if(ycf_async.__aysncTaskList&&ycf_async.__aysncTaskList.length>0){$.each(ycf_async.__aysncTaskList,function(a){if(ycf_async.__aysncTaskList[a].end==null){ycf_async.__aysncTaskList[a].end=ycf_async.__aysncTaskList[a].start
}if(Date.compare(d,Date.parse(ycf_async.__aysncTaskList[a].start))>=0&&Date.compare(d,Date.parse(ycf_async.__aysncTaskList[a].end))<=0){f++;
if((((d.getTime()-Date.parse(ycf_async.__aysncTaskList[a].start).getTime())/60000)%ycf_async.__aysncTaskList[a].remindMins)<=1&&ycf_async.__aysncTaskList[a].taskState!=4&&(ycf_async.__aysncTaskList[a].remindType%2==1)){e.push(ycf_async.__aysncTaskList[a])
}}});
if(f>0){$("#MyTaskCount").show();
$("#MyTaskCount").html(f);
$("#my_task_count").show();
$("#my_task_count").html(f)
}else{$("#MyTaskCount").hide();
$("#my_task_count").hide()
}}return e
};
if(!!ycf_async.__aysncTaskList&&ycf_async.__aysncTaskList.length<=0){ycf_crm.getTaskList(null,function(b){if(!!ycf_async.__aysncTaskList&&ycf_async.__aysncTaskList.length<=0){if(b&&b.length>0){$.each(b,function(a){ycf_async.__aysncTaskList.push(ycf_async.handlerTask(b[a]))
})
}}},function(b){console.log(b)
})
}$(function(){var isFirstLoad=false;
var taskHand=function(){var _firstLoad=isFirstLoad;
var asyncTask=ycf_async.findRemindTask();
if(asyncTask&&asyncTask.length>0){if(_firstLoad){$.each(asyncTask,function(i){$.gritter.add({title:asyncTask[i].title,text:'<a href="#modal-showTask" role="button" class="sp_gritter" data-toggle="modal" eId="'+asyncTask[i].id+'">'+asyncTask[i].content+"</a>",time:590000,image:"../../Content/images/envelope.png",sticky:false})
})
}isFirstLoad=true
}};
var taskHandAsync=eval(Wind.compile("async",function(interval){while(true){taskHand();
if(isFirstLoad){$await(Wind.Async.sleep(interval))
}else{$await(Wind.Async.sleep(1000))
}}}));
taskHandAsync(59000).start()
});